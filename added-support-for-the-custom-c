added support for the custom content loader

From: Chanwit Kaewkasi <chanwit@gmail.com>


---
 zk/src/org/zkoss/zk/ui/metainfo/ComponentInfo.java |   23 ++++++++++++++++++++
 .../org/zkoss/zk/ui/metainfo/PageDefinitions.java  |   21 +++++++++++++++++-
 2 files changed, 43 insertions(+), 1 deletions(-)
 mode change 100644 => 100755 zk/src/org/zkoss/zk/ui/metainfo/ComponentInfo.java
 mode change 100644 => 100755 zk/src/org/zkoss/zk/ui/metainfo/PageDefinitions.java

diff --git a/zk/src/org/zkoss/zk/ui/metainfo/ComponentInfo.java b/zk/src/org/zkoss/zk/ui/metainfo/ComponentInfo.java
old mode 100644
new mode 100755
index 877a25b..c2d4883
--- a/zk/src/org/zkoss/zk/ui/metainfo/ComponentInfo.java
+++ b/zk/src/org/zkoss/zk/ui/metainfo/ComponentInfo.java
@@ -25,6 +25,8 @@ import java.util.Set;
 import java.util.Collection;
 import java.util.Collections;
 
+import java.lang.reflect.Method;
+
 import org.zkoss.lang.D;
 import org.zkoss.lang.Strings;
 import org.zkoss.lang.Classes;
@@ -392,8 +394,29 @@ implements Cloneable, Condition, java.io.Externalizable {
 		if (cp != null)
 			composers.add(cp);
 	}
+
+	private static Class composerResolver = null;
+	public static void setComposerResolver(Class c) {
+		composerResolver = c;
+	}
+
 	private static Composer toComposer(Page page, Object o)
 	throws Exception {
+		if(composerResolver != null) {
+			try {
+				Method m = composerResolver.getMethod(
+					"resolveComposer", 
+					new Class[]{Page.class, String.class}
+				);
+				if(o instanceof String) {
+					Composer result = (Composer)m.invoke(
+						null,
+						new Object[]{page, o}
+					);
+					if(result != null) return result;
+				}
+			}catch(Throwable e) { e.printStackTrace(); }
+		}
 		if (o instanceof String) {
 			final String clsnm = ((String)o).trim();
 			o = page != null ? page.resolveClass(clsnm).newInstance():
diff --git a/zk/src/org/zkoss/zk/ui/metainfo/PageDefinitions.java b/zk/src/org/zkoss/zk/ui/metainfo/PageDefinitions.java
old mode 100644
new mode 100755
index d628a25..31c2b86
--- a/zk/src/org/zkoss/zk/ui/metainfo/PageDefinitions.java
+++ b/zk/src/org/zkoss/zk/ui/metainfo/PageDefinitions.java
@@ -37,6 +37,8 @@ import org.zkoss.zk.ui.Execution;
 import org.zkoss.zk.ui.Executions;
 import org.zkoss.zk.ui.metainfo.Parser;
 
+import java.lang.reflect.Constructor;
+
 /**
  * Utilities to retrieve page definitions.
  *
@@ -163,14 +165,31 @@ public class PageDefinitions {
 			return new ServletContextLocator((ServletContext)ctx, path);
 		throw new UnsupportedOperationException("Unknown context: "+ctx);
 	}
+	
+	private static Class RESOURCE_LOADER_CLASS = null;
+	public static void setResourceLoaderClass(Class c) {
+		RESOURCE_LOADER_CLASS = c;
+	}
 
 	private static final ResourceCache getCache(WebApp wapp) {
 		ResourceCache cache = (ResourceCache)wapp.getAttribute(ATTR_PAGE_CACHE);
 		if (cache == null) {
 			synchronized (PageDefinitions.class) {
 				cache = (ResourceCache)wapp.getAttribute(ATTR_PAGE_CACHE);
+				ResourceLoader rLoader = null;
 				if (cache == null) {
-					cache = new ResourceCache(new MyLoader(wapp), 167);
+					try {
+						Class rlClass = RESOURCE_LOADER_CLASS;
+						if(rlClass == null) rLoader = new MyLoader(wapp);
+						else {
+							Constructor ctor = rlClass.getDeclaredConstructor(new Class[]{WebApp.class});
+							rLoader = (ResourceLoader)ctor.newInstance(new Object[]{wapp});
+						}
+					} catch(Throwable e) {
+						e.printStackTrace();
+						rLoader = new MyLoader(wapp);
+					}
+					cache = new ResourceCache(rLoader, 167);
 					cache.setMaxSize(1024);
 					cache.setLifetime(60*60000); //1hr
 					wapp.setAttribute(ATTR_PAGE_CACHE, cache);
